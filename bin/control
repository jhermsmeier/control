#!/usr/bin/env node
'use strict'

var fs = require( 'fs' )
var path = require( 'path' )
var control = require( '..' )
var argv = process.argv.slice( 2 )

var files = []

global.context = (...argv) => { control.context( ...argv ) }
global.setup = (...argv) => { control.setup( ...argv ) }
global.teardown = (...argv) => { control.teardown( ...argv ) }
global.before = (...argv) => { control.before( ...argv ) }
global.after = (...argv) => { control.after( ...argv ) }
global.test = (...argv) => { control.test( ...argv ) }
global.skip = (...argv) => { control.skip( ...argv ) }
global.only = (...argv) => { control.only( ...argv ) }

argv.forEach(( filename ) => {
  var stats = fs.statSync( filename )
  if( stats.isDirectory() ) {
    fs.readdirSync( filename )
      .filter(( basename ) => path.extname( basename ) == '.js' )
      .forEach(( basename ) => {
        files.push( path.join( process.cwd(), filename, basename ) )
      })
  } else {
    files.push( path.join( process.cwd(), filename ) )
  }
})

files.forEach(( filename ) => {
  require( filename )
})

control.run(( error ) => {

  if( error ) {
    console.error( error )
    process.exit( 1 )
  }

  process.exit( control.reporter.failedTests )

})
